; *************************************
; BEGIN OF RUSSIAN KEYBOARD HANDLER
; *************************************
;
I0DA5:  DEFB	030H,031H,032H,033H,034H,035H,036H,037
        DEFB	038H,039H,02DH,03DH,05CH,05BH,05DH,03B
        DEFB	027H,060H,02CH,02EH,02FH,02CH,061H,062
        DEFB	063H,064H,065H,066H,067H,068H,069H,06A
        DEFB	06BH,06CH,06DH,06EH,06FH,070H,071H,072
        DEFB	073H,074H,075H,076H,077H,078H,079H,07A

        DEFB	029H,021H,040H,023H,024H,025H,05EH,026
        DEFB	02AH,028H,05FH,02BH,07CH,07BH,07DH,03A
        DEFB	022H,07EH,03CH,03EH,03FH,02EH,041H,042
        DEFB	043H,044H,045H,046H,047H,048H,049H,04A
        DEFB	04BH,04CH,04DH,04EH,04FH,050H,051H,052
        DEFB	053H,054H,055H,056H,057H,058H,059H,05A

        DEFB	009H,0B4H,0BDH,0BCH,0B7H,0ADH,0AFH,0BB
        DEFB	0ACH,007H,0B0H,01FH,01EH,090H,08FH,09A
        DEFB	0A7H,001H,0B3H,0B2H,01DH,00DH,0A0H,096
        DEFB	08DH,08EH,082H,0ABH,0A9H,0A6H,085H,0A3
        DEFB	0A5H,097H,094H,092H,09FH,083H,080H,09B
        DEFB	0A1H,093H,095H,0B1H,09CH,01CH,091H,087

        DEFB	00AH,0B5H,003H,004H,005H,006H,084H,00B
        DEFB	00CH,008H,017H,0B1H,016H,03CH,03EH,0AA
        DEFB	000H,002H,0BEH,0BFH,0B6H,00EH,00FH,01A
        DEFB	0AEH,0A2H,088H,098H,014H,015H,08AH,013
        DEFB	0A4H,0A8H,01BH,011H,09EH,089H,086H,0B8
        DEFB	010H,018H,019H,08CH,09DH,0BAH,012H,08B

        DEFB	030H,031H,032H,033H,034H,035H,036H,037
        DEFB	038H,039H,02DH,03DH,02FH,0C8H,0DFH,0D6
        DEFB	0DCH,017H,0C2H,0C0H,099H,02CH,0C6H,0C9
        DEFB	0D3H,0D7H,0D5H,0C1H,0D0H,0D2H,0DBH,0CF
        DEFB	0CCH,0C4H,0D8H,0D4H,0DDH,0DAH,0CAH,0CB
        DEFB	0D9H,0C5H,0C7H,0CDH,0C3H,0DEH,0CEH,0D1

        DEFB	029H,021H,022H,023H,03BH,025H,03AH,03F
        DEFB	02AH,028H,05FH,02BH,05CH,0E8H,0FFH,0F6
        DEFB	0FCH,010H,0E2H,0E0H,0B9H,02EH,0E6H,0E9
        DEFB	0F3H,0F7H,0F5H,0E1H,0F0H,0F2H,0FBH,0EF
        DEFB	0ECH,0E4H,0F8H,0F4H,0FDH,0FAH,0EAH,0EB
        DEFB	0F9H,0E5H,0E7H,0EDH,0E3H,0FEH,0EEH,0F1


J0EC5:	LD	E,C
        LD	D,00H
        LD	HL,FNKFLG-035H
        ADD	HL,DE
        LD	A,(HL)
        AND	A
        JR	NZ,J0EE3
J0ED0:	EX	DE,HL
        ADD	HL,HL
        ADD	HL,HL
        ADD	HL,HL
        ADD	HL,HL
        LD	DE,FNKSTR-035H*16
        ADD	HL,DE
        EX	DE,HL
J0EDA:	LD	A,(DE)
        AND	A
        RET	Z
        CALL	C0F55
        INC	DE
        JR	J0EDA

J0EE3:	LD	HL,(CURLIN)
        INC	HL
        LD	A,H
        OR	L
        JR	Z,J0ED0
        LD	HL,TRPTBL-035H*3
        ADD	HL,DE
        ADD	HL,DE
        ADD	HL,DE

;	Subroutine	raise trap
;	Inputs		________________________
;	Outputs		________________________
;	Remark		code identical among keyboard layout versions

C0EF1:	LD	A,(HL)
        AND	01H
        RET	Z
        LD	A,(HL)
        OR	04H
        CP	(HL)
        RET	Z
        LD	(HL),A
        XOR	05H
        RET	NZ
        LD	A,(ONGSBF)
        INC	A
        LD	(ONGSBF),A
        RET	

J0F06:	LD	A,(NEWKEY+6)
        RRCA	
        LD	A,0CH
        SBC	A,0
        JR	C0F55

;	  Subroutine key handler for scancode 030H and above returning normal keycode
;	     Inputs  ________________________
;	     Outputs ________________________

J0F10:	CALL	H.KEYA		; SHIFT,CTRL,GRAPH handler
        LD	E,A
        LD	D,00H
        LD	HL,D1033-030H
        ADD	HL,DE
        LD	A,(HL)
        AND	A
        RET	Z			; no action, quit
        JR	C0F55

;	  Subroutine russian �kana� key
;	     Inputs  ________________________
;	     Outputs ________________________

J0F1F:	LD	HL,KANAST	; TODO migrate, using free space at 0x1098. Hence handler itself must be at 0x0F**, jump needed.
        LD	A,(HL)
        CPL	
        LD	(HL),A
J0F29:	LD	A,0FH	; TODO or maybe move this to 0x1098, hence no need to be at 0x0F**, this will give more space to handler above.
        OUT	(0A0H),A
        IN	A,(0A2H)
        AND	7FH
        LD	B,A
        LD	A,(HL)
        CPL	
        AND	80H
        OR	B
        OUT	(0A1H),A
        RET

;	  Subroutine CAPS key handler
;	     Inputs  ________________________
;	     Outputs ________________________

J0F36:	LD	HL,CAPST		; CAPS handler
        LD	A,(HL)
        CPL	
        LD	(HL),A
        CPL	

K.BCAP:	AND	A
        LD	A,0CH
        JR	Z,J0F43
        INC	A
J0F43:	OUT	(0ABH),A
        RET	

J0F46:	LD	A,(NEWKEY+6)
        RRCA	
        RRCA	
        LD	A,03H
        JR	NC,J0F50
        INC	A
J0F50:	LD	(INTFLG),A
        JR	C,J0F64

;	  Subroutine __________________________
;	     Inputs  ________________________
;	     Outputs ________________________

C0F55:	LD	HL,(PUTPNT)
        LD	(HL),A
        CALL	C105B
        LD	A,(GETPNT)
        CP	L
        RET	Z
        LD	(PUTPNT),HL
J0F64:	LD	A,(CLIKSW)
        AND	A
        RET	Z
        LD	A,(CLIKFL)
        AND	A
        RET	NZ
        LD	A,0FH
        LD	(CLIKFL),A
        OUT	(0ABH),A
        LD	A,0AH
J0F77:	DEC	A
        JR	NZ,J0F77

K.BSND:	AND	A
        LD	A,0EH
        JR	Z,J0F80
        INC	A
J0F80:	OUT	(0ABH),A
        RET	

;	  Subroutine ordinary key handler
;	     Inputs  ________________________
;	     Outputs ________________________

J0F83:	LD	A,(NEWKEY+6)
        LD	E,A
        RRA	
        RRA	
        PUSH	AF
        LD	A,E
        CPL	
        JR	NC,J0F9E		; CTRL pressed,
        RRA	
        RRA	
        RLCA	
        AND	03H	; 3 
        BIT	1,A
        JR	NZ,J0FA0		; GRAPH pressed,
        JP	J1067			; patched code, handle russian �kana�, resumes at 0FA0H

        DEFS	0F9EH-$,0		; unused space

J0F9E:	AND	001H			; SHIFT state
J0FA0:	LD	E,A
        ADD	A,A
        ADD	A,E
        ADD	A,A
        ADD	A,A
        ADD	A,A
        ADD	A,A
        LD	E,A				; SHIFT state * 48
        LD	D,00H
        LD	HL,I0DA5
        ADD	HL,DE
        LD	B,D
        ADD	HL,BC
        POP	AF
        LD	A,(HL)
        INC	A
        DEFB 00H, 00H, 00H	; no dead key handle, usual key for RU.
        DEC	A
        RET	Z			; no action for key, quit
        JR	C,J0FD0			; CTRL not pressed,
        AND	0DFH
        SUB	40H
        CP	20H
        RET	NC
J0FC1:	JR	C0F55

;	  Subroutine function key handler
;	     Inputs  ________________________
;	     Outputs ________________________

J0FC3:	LD	A,(NEWKEY+6)
        RRCA	
        JR	C,J0FCD
        LD	A,C
        ADD	A,05H
        LD	C,A
J0FCD:	JP	J0EC5

J0FD0:	CP	20H
        JR	NC,J0FDF
        PUSH	AF
        LD	A,01H
        CALL	C0F55
        POP	AF
        ADD	A,40H
        JR	J0FC1

J0FDF:	JP	J1073			; patch code for upcase

        DEFS	00FF0H-$,0		; unused space

J0FEE:	AND	0DFH
J0FF0:	JP	C0F55

        DEFS	01011H-$,0		; unused space

J1011:	JP	C0F55

        DEFS	01021H-$,0		; usused space

K.HAND:	LD	A,C
        LD	HL,I1B96
        CALL	H.KEYC
        LD	D,0FH
J102A:	CP	(HL)
        INC	HL
        LD	E,(HL)
        INC	HL
        PUSH	DE
        RET	C
        POP	DE
        JR	J102A

D1033:	DEFB	00H,00H,00H,00H,00H,00H,00H,00H
        DEFB	00H,00H,1BH,09H,00H,08H,18H,0DH
        DEFB	20H,0CH,12H,7FH,1DH,1EH,1FH,1CH
        DEFB	0DH,2BH,2AH,30H,31H,32H,33H,34H
        DEFB	35H,36H,37H,38H,39H,2DH,2CH,2EH

;	  Subroutine __________________________
;	     Inputs  ________________________
;	     Outputs ________________________

C105B:	XOR	A
        NOP
        NOP
        NOP				; patch hole, normaly resets KANAST
        JR	C10C2

        DEFS	01067H-$,0		; unused space

J1067:	PUSH	AF
        LD	A,(KANAST)
        AND	04H
        LD	E,A
        POP	AF
        OR	E
        JP	J0FA0

J1073:	LD	HL,CAPST
        INC	(HL)
        DEC	(HL)
        JP	Z,J0FF0
        CP	099H	; ё
        JR	Z,RU_UPC;
        CP	61H
        JP	C,J1011
        CP	0E0H
        JP	NC,J1011
        CP	7BH
        JP	C,J0FEE
        CP	0C0H
        JP	C,J1011
RU_UPC: OR	20H
        JP	J0FF0

J1098:  DEFS	010C2H-$,0		; unused space

        ORG	01B94H

        JR	J1BAC

I1B96:	DEFB	030H,J0F83 AND 255		; scancodes 000H-02FH
        DEFB	033H,J0F10 AND 255		; SHIFT,CTRL,GRAPH
        DEFB	034H,J0F36 AND 255		; CAPS
        DEFB	035H,J0F1F AND 255		; CODE
        DEFB	03AH,J0FC3 AND 255		; F1,F2,F3,F4,F5
        DEFB	03CH,J0F10 AND 255		; ESC,TAB
        DEFB	03DH,J0F46 AND 255		; STOP
        DEFB	041H,J0F10 AND 255		; BS,SELECT,RETURN,SPACE
        DEFB	042H,J0F06 AND 255		; HOME
        DEFB	0FFH,J0F10 AND 255		; ins,del,left,up,down,right, numeric pad

        DEFS	01BABH-$,0

; *************************************
; END OF RUSSIAN KEYBOARD HANDLER
; *************************************
